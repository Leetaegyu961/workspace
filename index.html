<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>우주 일정 기록</title>
  <meta name="description" content="오늘의 할 일을 별처럼 기록하고, 하루 우주들이 모여 일주일·한달·일년 우주를 만드는 감성 일정 페이지" />
  <meta name="theme-color" content="#05060d" />
  <style>
    :root{
      --bg:#05060d;
      --bg2:#0c0f24;
      --card:rgba(14,20,44,.72);
      --text:#eef3ff;
      --muted:#9aa8d6;
      --line:rgba(255,255,255,.12);
      --accent:#7aa7ff;
      --accent2:#8ef4d5;
      --glow:0 0 28px rgba(122,167,255,.45);
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Pretendard", "Noto Sans KR", "Apple SD Gothic Neo", system-ui, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(122,167,255,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 20%, rgba(142,244,213,.18), transparent 55%),
        radial-gradient(1200px 800px at 50% 120%, rgba(20,28,60,.9), transparent 70%),
        linear-gradient(180deg, #04050b, #0a0f22 70%, #0c122b);
      min-height:100vh;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:28px 18px 60px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .panel{padding:18px}
    .layout{display:grid;gap:16px;grid-template-columns: 1fr}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font:inherit;
    }
    textarea{min-height:80px;resize:vertical}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition: transform .08s ease, background .15s ease, opacity .15s ease;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); background:rgba(255,255,255,.12)}
    button.primary{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#061022;
      font-weight:800;
    }
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .quick-add{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 120px 140px 140px 90px;
      align-items:center;
      background:rgba(8,12,26,.7);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      position:sticky;
      top:12px;
      z-index:2;
      backdrop-filter: blur(8px);
    }
    @media (max-width: 980px){
      .quick-add{grid-template-columns: 1fr 1fr; position:static}
    }
    .hidden{display:none !important}
    .ghost{
      border:1px dashed var(--line);
      background:transparent;
    }
    .seg{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .seg input{display:none}
    .seg label{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      background:rgba(255,255,255,.04);
    }
    .seg input:checked + label{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#061022;
      font-weight:800;
    }
    .fab{
      position:fixed;
      right:24px;
      bottom:24px;
      z-index:5;
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#061022;
      font-weight:800;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      border-radius:999px;
      padding:12px 16px;
    }
    .panel-drawer{
      position:fixed;
      right:24px;
      bottom:86px;
      width:min(520px, calc(100vw - 48px));
      z-index:4;
      box-shadow:var(--shadow);
    }
    .sky-hint{
      position:absolute;
      left:18px;
      bottom:16px;
      font-size:12px;
      color:var(--muted);
      background:rgba(8,12,26,.55);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }
    .composer{
      position:fixed;
      left:50%;
      bottom:26px;
      transform: translateX(-50%);
      width:min(700px, calc(100vw - 32px));
      z-index:6;
      background:rgba(8,12,26,.9);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:12px;
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 260px 140px 80px 80px;
      align-items:center;
      backdrop-filter: blur(10px);
    }
    .composer.floating{
      transform: translate(-50%, -100%);
      bottom:auto;
    }
    .composer[aria-hidden="true"]{display:none}
    @media (max-width: 820px){
      .composer{grid-template-columns: 1fr 1fr; width:min(560px, calc(100vw - 24px));}
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:96px;
      transform: translateX(-50%);
      background:rgba(8,12,26,.9);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:7;
    }
    .intro{
      position:fixed;
      inset:0;
      background:rgba(3,5,12,.7);
      backdrop-filter: blur(10px);
      z-index:8;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .intro-card{
      width:min(560px, calc(100vw - 32px));
      background:rgba(10,14,28,.92);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
    }
    .intro-card h2{margin:0 0 8px;font-size:18px}
    .intro-card p{margin:0;color:var(--muted);font-size:13px;line-height:1.6}
    .intro-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px)}
    .scope-bar{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:12px
    }
    .scope-btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .scope-btn[data-active="true"]{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#061022;
      font-weight:800;
    }
    .sky{
      position:relative;
      min-height:100vh;
      border-radius:0;
      border:0;
      overflow:hidden;
      background:
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.5), transparent 60%),
        radial-gradient(2px 2px at 80% 20%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 55% 60%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1.5px 1.5px at 75% 75%, rgba(255,255,255,.4), transparent 60%),
        radial-gradient(1.5px 1.5px at 25% 70%, rgba(255,255,255,.4), transparent 60%),
        linear-gradient(180deg, #080a18, #0d1430 70%, #0b1230);
      cursor: crosshair;
    }
    .sky::before{
      content:"";
      position:absolute;inset:0;
      background:
        radial-gradient(700px 380px at 10% 100%, rgba(122,167,255,.15), transparent 60%),
        radial-gradient(600px 320px at 100% 10%, rgba(142,244,213,.12), transparent 60%);
      pointer-events:none;
    }
    .constellation{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:0;
    }
    .star{
      position:absolute;
      width:10px;height:10px;
      border-radius:999px;
      z-index:1;
      background: radial-gradient(circle, #ffffff 0%, #c7d6ff 45%, rgba(122,167,255,.1) 70%, transparent 75%);
      box-shadow: 0 0 18px rgba(122,167,255,.55);
      transform: translate(-50%, -50%);
      opacity:.9;
      animation: twinkle 4s ease-in-out infinite;
      cursor:pointer;
    }
    .star.is-new{
      animation: birth .7s ease-out, twinkle 4s ease-in-out infinite;
    }
    .star.is-selected{
      outline:2px solid rgba(255,255,255,.65);
      outline-offset:4px;
    }
    .star[data-done="true"]{
      background: radial-gradient(circle, #bfffea 0%, #8ef4d5 50%, rgba(142,244,213,.2) 70%, transparent 78%);
      box-shadow: 0 0 22px rgba(142,244,213,.6);
    }
    .star[data-done="false"]{
      opacity:.35;
      box-shadow: 0 0 6px rgba(122,167,255,.2);
      filter: saturate(.7);
    }
    .star[data-kind="업무"]{background: radial-gradient(circle, #ffe8c7 0%, #ffbf7a 55%, rgba(255,191,122,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(255,191,122,.55)}
    .star[data-kind="공부"]{background: radial-gradient(circle, #dbe8ff 0%, #8fb5ff 55%, rgba(143,181,255,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(143,181,255,.55)}
    .star[data-kind="운동"]{background: radial-gradient(circle, #ffd6e6 0%, #ff8bb5 55%, rgba(255,139,181,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(255,139,181,.55)}
    .star[data-kind="가족"]{background: radial-gradient(circle, #fff2c8 0%, #ffd986 55%, rgba(255,217,134,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(255,217,134,.55)}
    .star[data-kind="취미"]{background: radial-gradient(circle, #ebdcff 0%, #c29bff 55%, rgba(194,155,255,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(194,155,255,.55)}
    .star[data-kind="휴식"]{background: radial-gradient(circle, #d9fff2 0%, #7fe6c8 55%, rgba(127,230,200,.2) 75%, transparent 80%); box-shadow:0 0 22px rgba(127,230,200,.55)}
    .star[data-status="low"]{background: radial-gradient(circle, #dbe8ff 0%, #7aa7ff 55%, rgba(122,167,255,.2) 75%, transparent 80%); box-shadow:0 0 18px rgba(122,167,255,.5)}
    .star[data-status="mid"]{background: radial-gradient(circle, #dff7ff 0%, #8fe4ff 55%, rgba(143,228,255,.2) 75%, transparent 80%); box-shadow:0 0 18px rgba(143,228,255,.5)}
    .star[data-status="high"]{background: radial-gradient(circle, #e7ffe4 0%, #7ef0b1 55%, rgba(126,240,177,.2) 75%, transparent 80%); box-shadow:0 0 18px rgba(126,240,177,.5)}
    .star[data-status="full"]{background: radial-gradient(circle, #fff4d2 0%, #ffd87a 55%, rgba(255,216,122,.2) 75%, transparent 80%); box-shadow:0 0 20px rgba(255,216,122,.55)}
    @keyframes twinkle{0%,100%{opacity:.65}50%{opacity:1}}
    @keyframes birth{
      0%{transform: translate(-50%, -50%) scale(.2); opacity:0}
      60%{transform: translate(-50%, -50%) scale(1.25); opacity:1}
      100%{transform: translate(-50%, -50%) scale(1); opacity:.95}
    }
    .star-label{
      position:absolute;
      transform: translate(-50%, calc(-50% - 18px));
      font-size:11px;
      color:var(--text);
      text-shadow: 0 0 8px rgba(0,0,0,.8);
      white-space:nowrap;
      opacity:.9;
    }
    .legend{
      display:flex;gap:12px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);margin-top:10px
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .dot.todo{background:#c7d6ff;box-shadow:0 0 12px rgba(122,167,255,.4)}
    .dot.done{background:#8ef4d5;box-shadow:0 0 12px rgba(142,244,213,.4)}
    .list{margin:0;padding:0;list-style:none;display:grid;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:rgba(255,255,255,.04)
    }
    .item strong{display:block;font-size:13px}
    .item span{font-size:12px;color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);border-radius:999px;
      padding:4px 8px;background:rgba(255,255,255,.04)
    }
    footer{margin-top:18px;color:var(--muted);font-size:12px}
    .help{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="sky" id="sky" role="img" aria-label="일정이 별로 표시되는 영역">
    <canvas class="constellation" id="constellation" aria-hidden="true"></canvas>
    <div class="sky-hint">하늘을 클릭해 별을 추가하세요</div>
  </div>

  <div class="wrap">
    <section class="layout">
      <div class="card panel hidden panel-drawer" id="inputPanel" aria-label="빠른 입력">
        <div class="quick-add">
          <input type="text" id="title" placeholder="오늘의 할 일을 입력하세요" aria-label="일정 제목" />
          <select id="kind" aria-label="종류">
            <option value="업무">업무</option>
            <option value="공부">공부</option>
            <option value="운동">운동</option>
            <option value="가족">가족</option>
            <option value="취미">취미</option>
            <option value="휴식">휴식</option>
          </select>
          <select id="intensity" aria-label="강도">
            <option value="상">상</option>
            <option value="중" selected>중</option>
            <option value="하">하</option>
          </select>
          <input type="date" id="date" aria-label="날짜" />
          <button class="primary" id="add">추가</button>
          <button class="ghost" id="clear">비우기</button>
        </div>
        <div class="scope-bar" role="tablist" aria-label="우주 범위">
          <button class="scope-btn" data-scope="day" data-active="true">하루 우주</button>
          <button class="scope-btn" data-scope="week" data-active="false">일주일 우주</button>
          <button class="scope-btn" data-scope="month" data-active="false">한달 우주</button>
          <button class="scope-btn" data-scope="year" data-active="false">일년 우주</button>
        </div>
        <div class="help">별을 드래그해 나만의 별자리를 만들 수 있어요. 별을 클릭하면 완료 체크가 토글됩니다.</div>
      </div>

    </section>

    <section class="card panel hidden" id="listPanel" aria-label="일정 목록" style="margin-top:16px">
      <h2 style="margin:0 0 10px;font-size:16px" id="listTitle">오늘의 별 목록</h2>
      <label>
        감정
        <select id="mood">
          <option value="따뜻함">따뜻함</option>
          <option value="설렘">설렘</option>
          <option value="차분함">차분함</option>
          <option value="결의">결의</option>
          <option value="그리움">그리움</option>
        </select>
      </label>
      <label style="margin-top:8px">
        메모
        <textarea id="note" placeholder="이 일정이 왜 중요한지 한 줄 남겨보세요"></textarea>
      </label>
      <ul class="list" id="list"></ul>
    </section>

  </div>

  <button class="fab" id="openInput" aria-expanded="false">새 별</button>
  <div class="composer hidden" id="composer" aria-label="빠른 추가" aria-hidden="true">
    <input type="text" id="quickTitle" placeholder="오늘 할 일을 적어주세요" aria-label="오늘 할 일" />
    <div class="seg" role="group" aria-label="종류">
      <input type="radio" id="kind-work" name="quickKind" value="업무" checked />
      <label for="kind-work">업무</label>
      <input type="radio" id="kind-study" name="quickKind" value="공부" />
      <label for="kind-study">공부</label>
      <input type="radio" id="kind-ex" name="quickKind" value="운동" />
      <label for="kind-ex">운동</label>
      <input type="radio" id="kind-family" name="quickKind" value="가족" />
      <label for="kind-family">가족</label>
      <input type="radio" id="kind-hobby" name="quickKind" value="취미" />
      <label for="kind-hobby">취미</label>
      <input type="radio" id="kind-rest" name="quickKind" value="휴식" />
      <label for="kind-rest">휴식</label>
    </div>
    <div class="seg" role="group" aria-label="강도">
      <input type="radio" id="int-high" name="quickIntensity" value="상" />
      <label for="int-high">상</label>
      <input type="radio" id="int-mid" name="quickIntensity" value="중" checked />
      <label for="int-mid">중</label>
      <input type="radio" id="int-low" name="quickIntensity" value="하" />
      <label for="int-low">하</label>
    </div>
    <button class="primary" id="quickAdd">추가</button>
    <button class="ghost" id="quickCancel">취소</button>
  </div>
  <div class="toast" id="toast" role="status" aria-live="polite">별이 만들어졌어요. 클릭해서 완료를 체크하세요.</div>
  <div class="intro" id="intro">
    <div class="intro-card">
      <h2>당신의 하루는 별이 됩니다</h2>
      <p>하늘을 클릭하면 그 자리에 별이 태어납니다. 별을 클릭하면 완료가 체크되고, 모인 별은 당신만의 별자리가 됩니다.</p>
      <p>복잡한 입력은 줄이고, 한 줄로 기록하세요.</p>
      <div class="intro-actions">
        <button class="primary" id="introStart">시작하기</button>
        <button class="ghost" id="introLater">나중에</button>
      </div>
    </div>
  </div>

  <script>
    const $title = document.getElementById('title');
    const $date = document.getElementById('date');
    const $mood = document.getElementById('mood');
    const $kind = document.getElementById('kind');
    const $intensity = document.getElementById('intensity');
    const $note = document.getElementById('note');
    const $add = document.getElementById('add');
    const $clear = document.getElementById('clear');
    const $sky = document.getElementById('sky');
    const $list = document.getElementById('list');
    const $constellation = document.getElementById('constellation');
    const $listTitle = document.getElementById('listTitle');
    const $openInput = document.getElementById('openInput');
    const $inputPanel = document.getElementById('inputPanel');
    const $listPanel = document.getElementById('listPanel');
    const $composer = document.getElementById('composer');
    const $quickTitle = document.getElementById('quickTitle');
    const $quickAdd = document.getElementById('quickAdd');
    const $quickCancel = document.getElementById('quickCancel');
    const $toast = document.getElementById('toast');
    const $intro = document.getElementById('intro');
    const $introStart = document.getElementById('introStart');
    const $introLater = document.getElementById('introLater');

    const tasks = [];
    const aggregatePositions = new Map();

    let scope = 'day';
    let focusDate = new Date();
    let dragging = null;
    let suppressClickOnce = false;
    let pendingPos = null;
    let longPressTimer = null;
    let linkPendingId = null;
    const linksByScope = new Map();

    function pad(n){return String(n).padStart(2,'0');}
    function toISO(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
    function parseISO(s){
      const [y,m,da] = s.split('-').map(Number);
      return new Date(y, m-1, da);
    }
    function startOfWeek(d){
      const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = (date.getDay() + 6) % 7;
      date.setDate(date.getDate() - day);
      return date;
    }
    function startOfMonth(d){
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function startOfYear(d){
      return new Date(d.getFullYear(), 0, 1);
    }
    function clamp(val, min, max){return Math.max(min, Math.min(max, val));}

    function getSeedX(i){
      const angle = i * 0.85;
      const radius = Math.min(28 + i * 2.2, 42);
      return clamp(50 + Math.cos(angle) * radius, 8, 92);
    }
    function getSeedY(i){
      const angle = i * 0.85;
      const radius = Math.min(18 + i * 1.8, 36);
      return clamp(50 + Math.sin(angle) * radius, 10, 88);
    }
    function getAggregatePos(key, i){
      if(aggregatePositions.has(key)) return aggregatePositions.get(key);
      const pos = { x: getSeedX(i), y: getSeedY(i) };
      aggregatePositions.set(key, pos);
      return pos;
    }

    function sizeByIntensity(intensity){
      return intensity === '상' ? 16 : (intensity === '중' ? 12 : 8);
    }
    function sizeByCount(count){
      if(count >= 8) return 18;
      if(count >= 5) return 15;
      if(count >= 3) return 12;
      return 9;
    }
    function statusByRatio(doneCount, total){
      if(total === 0) return 'low';
      if(doneCount === total) return 'full';
      const ratio = doneCount / total;
      if(ratio >= 0.75) return 'high';
      if(ratio >= 0.4) return 'mid';
      return 'low';
    }

    function buildNodes(){
      if(scope === 'day'){
        const dayKey = toISO(focusDate);
        return tasks
          .filter(t => t.date === dayKey)
          .map((t, i) => ({
            id: t.id,
            type: 'task',
            title: t.title,
            x: t.x,
            y: t.y,
            size: t.size,
            done: t.done,
            kind: t.kind,
            label: t.title,
            ref: t
          }));
      }

      const groups = new Map();
      tasks.forEach(t => {
        const d = parseISO(t.date);
        let key = '';
        let label = '';
        if(scope === 'week'){
          const ws = startOfWeek(d);
          key = toISO(ws);
          label = `${pad(ws.getMonth()+1)}/${pad(ws.getDate())}`;
        } else if(scope === 'month'){
          const ms = startOfMonth(d);
          const ws = startOfWeek(d);
          key = `${ms.getFullYear()}-${pad(ms.getMonth()+1)}-W${Math.ceil((d.getDate())/7)}`;
          label = `${pad(d.getMonth()+1)}월 ${Math.ceil(d.getDate()/7)}주`;
        } else {
          const ys = startOfYear(d);
          key = `${ys.getFullYear()}-${pad(d.getMonth()+1)}`;
          label = `${pad(d.getMonth()+1)}월`;
        }
        if(!groups.has(key)){
          groups.set(key, { key, label, total:0, done:0, dates:[] });
        }
        const g = groups.get(key);
        g.total += 1;
        g.done += t.done ? 1 : 0;
        g.dates.push(t.date);
      });

      const entries = Array.from(groups.values()).sort((a,b) => a.key.localeCompare(b.key));
      return entries.map((g, i) => {
        const pos = getAggregatePos(`${scope}:${g.key}`, i);
        return {
          id: g.key,
          type: 'aggregate',
          title: g.label,
          x: pos.x,
          y: pos.y,
          size: sizeByCount(g.total),
          done: g.total > 0 && g.done === g.total,
          status: statusByRatio(g.done, g.total),
          label: g.label,
          meta: `${g.done}/${g.total}`,
          group: g
        };
      });
    }

    function linkKey(a, b){
      return [a, b].sort().join('|');
    }

    function getScopeKey(){
      if(scope === 'day') return `day:${toISO(focusDate)}`;
      if(scope === 'week') return `week:${toISO(startOfWeek(focusDate))}`;
      if(scope === 'month') return `month:${focusDate.getFullYear()}-${pad(focusDate.getMonth()+1)}`;
      return `year:${focusDate.getFullYear()}`;
    }

    function getLinks(){
      const key = getScopeKey();
      if(!linksByScope.has(key)) linksByScope.set(key, new Set());
      return linksByScope.get(key);
    }

    function clearStars(){
      $sky.querySelectorAll('.star').forEach((n) => n.remove());
    }

    function render(){
      clearStars();
      $list.innerHTML = '';

      const nodes = buildNodes();
      nodes.forEach((n, idx) => {
        const star = document.createElement('div');
        star.className = 'star';
        if(n.ref && n.ref.justAdded) star.classList.add('is-new');
        star.dataset.idx = String(idx);
        star.dataset.type = n.type;
        if(n.kind) star.dataset.kind = n.kind;
        star.dataset.done = n.done ? 'true' : 'false';
        if(n.status) star.dataset.status = n.status;
        star.style.left = n.x + '%';
        star.style.top = n.y + '%';
        star.style.width = n.size + 'px';
        star.style.height = n.size + 'px';
        star.style.animationDelay = (idx * 0.3) + 's';

        const label = document.createElement('div');
        label.className = 'star-label';
        label.textContent = n.label;
        star.appendChild(label);

        star.title = n.type === 'task'
          ? `${n.title} / ${n.ref.date} / ${n.ref.kind} / ${n.ref.intensity}`
          : `${n.title} / ${n.meta}`;

        star.addEventListener('click', (e) => {
          if(e.shiftKey && n.type === 'task'){
            handleLinkClick(n.ref.id, star);
            return;
          }
          if(linkPendingId && n.type === 'task'){
            handleLinkClick(n.ref.id, star);
            return;
          }
          if(n.type === 'task'){
            toggleDone(n.ref.id);
          } else {
            drillDown(n.group);
          }
        });

        $sky.appendChild(star);
      });

      renderList();
      renderTitles();
      drawConstellation(nodes);
      tasks.forEach(t => { t.justAdded = false; });
    }

    function renderTitles(){
      if(scope === 'day'){
        $listTitle.textContent = '오늘의 별 목록';
      } else if(scope === 'week'){
        $listTitle.textContent = '이번 주의 별들';
      } else if(scope === 'month'){
        $listTitle.textContent = '이번 달의 별들';
      } else {
        $listTitle.textContent = '올해의 별들';
      }
    }

    function renderList(){
      if(scope === 'day'){
        const dayKey = toISO(focusDate);
        const filtered = tasks.filter(t => t.date === dayKey);
        filtered.forEach((t) => {
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
            <div>
              <strong>${t.title}</strong>
              <span>${t.date} · ${t.kind} · ${t.intensity}</span>
              <div class="sub" style="margin-top:6px">${t.note || '메모 없음'}</div>
            </div>
            <div>
              <button data-id="${t.id}" class="toggle">${t.done ? '완료됨' : '완료 체크'}</button>
            </div>
          `;
          $list.appendChild(li);
        });
        return;
      }

      const nodes = buildNodes();
      nodes.forEach((n) => {
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = `
          <div>
            <strong>${n.title}</strong>
            <span>${n.meta} 완료</span>
          </div>
          <div>
            <button data-key="${n.id}" class="drill">열기</button>
          </div>
        `;
        $list.appendChild(li);
      });

    }

    function buildTask(values){
      const id = Date.now() + Math.random().toString(16).slice(2);
      return {
        id,
        title: values.title,
        date: values.date,
        mood: values.mood,
        intensity: values.intensity,
        kind: values.kind,
        note: values.note,
        done: false,
        justAdded: true,
        x: values.x,
        y: values.y,
        size: sizeByIntensity(values.intensity)
      };
    }

    function addTaskFrom(values){
      tasks.push(buildTask(values));
      $title.value = '';
      $note.value = '';
      $quickTitle.value = '';
      focusDate = parseISO(values.date);
      pendingPos = null;
      render();
      showToast(pickLine(createLines));
    }

    function addTask(){
      const title = $title.value.trim();
      if(!title){
        alert('일정 제목을 입력해 주세요.');
        return;
      }
      const dateVal = $date.value || toISO(new Date());
      addTaskFrom({
        title,
        date: dateVal,
        mood: $mood.value,
        intensity: $intensity.value,
        kind: $kind.value,
        note: $note.value.trim(),
        x: pendingPos ? pendingPos.x : getSeedX(tasks.length),
        y: pendingPos ? pendingPos.y : getSeedY(tasks.length)
      });
    }

    function addTaskQuick(){
      const title = $quickTitle.value.trim();
      if(!title){
        alert('할 일을 한 줄로 입력해 주세요.');
        return;
      }
      const kind = document.querySelector('input[name="quickKind"]:checked')?.value || '업무';
      const intensity = document.querySelector('input[name="quickIntensity"]:checked')?.value || '중';
      const dateVal = $date.value || toISO(new Date());
      addTaskFrom({
        title,
        date: dateVal,
        mood: $mood.value,
        intensity,
        kind,
        note: '',
        x: pendingPos ? pendingPos.x : getSeedX(tasks.length),
        y: pendingPos ? pendingPos.y : getSeedY(tasks.length)
      });
      closeComposer();
    }

    function openComposerAt(x, y){
      $composer.classList.remove('hidden');
      $composer.setAttribute('aria-hidden', 'false');
      if(typeof x === 'number' && typeof y === 'number'){
        $composer.classList.add('floating');
        $composer.style.left = `${x}px`;
        $composer.style.top = `${y}px`;
      } else {
        $composer.classList.remove('floating');
        $composer.style.left = '50%';
        $composer.style.top = '';
      }
      $quickTitle.focus();
    }

    function closeComposer(){
      $composer.classList.add('hidden');
      $composer.setAttribute('aria-hidden', 'true');
      $composer.classList.remove('floating');
      $composer.style.top = '';
      pendingPos = null;
    }

    function showToast(message){
      $toast.textContent = message;
      $toast.classList.add('show');
      clearTimeout($toast._t);
      $toast._t = setTimeout(() => $toast.classList.remove('show'), 1600);
    }

    const createLines = [
      '하나의 별이 태어났어요.',
      '오늘의 마음이 별이 되었습니다.',
      '작은 약속이 우주에 기록됐어요.',
      '당신의 하루가 반짝이기 시작했어요.',
      '이 순간이 별자리에 남습니다.'
    ];
    const doneLines = [
      '별 하나가 더 밝아졌어요.',
      '완료한 순간, 우주가 응답합니다.',
      '작은 완성이 큰 빛이 됩니다.',
      '당신의 하루가 한 줄 더 빛나요.',
      '오늘의 용기가 별이 되었습니다.'
    ];
    const undoLines = [
      '별이 잠시 숨을 고릅니다.',
      '빛은 잠시 쉬어도 괜찮아요.',
      '조금 느려도, 다시 빛날 거예요.',
      '잠깐의 쉼도 기록됩니다.',
      '별빛은 다시 켜질 거예요.'
    ];
    function pickLine(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function toggleDone(id){
      const t = tasks.find(x => x.id === id);
      if(!t) return;
      t.done = !t.done;
      if(t.done){
        showToast(pickLine(doneLines));
      } else {
        showToast(pickLine(undoLines));
      }
      render();
    }

    function clearAll(){
      tasks.length = 0;
      aggregatePositions.clear();
      render();
    }

    function drillDown(group){
      if(scope === 'week'){
        focusDate = parseISO(group.key);
        setScope('day');
        return;
      }
      if(scope === 'month'){
        const sample = group.dates[0] || toISO(new Date());
        focusDate = parseISO(sample);
        setScope('week');
        return;
      }
      if(scope === 'year'){
        const sample = group.dates[0] || toISO(new Date());
        focusDate = parseISO(sample);
        setScope('month');
        return;
      }
    }

    function setScope(next){
      scope = next;
      document.querySelectorAll('.scope-btn').forEach(btn => {
        btn.dataset.active = btn.dataset.scope === next ? 'true' : 'false';
      });
      render();
    }

    function drawConstellation(nodes){
      if(!$constellation) return;
      const rect = $sky.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const w = rect.width;
      const h = rect.height;
      $constellation.width = Math.max(1, Math.floor(w * dpr));
      $constellation.height = Math.max(1, Math.floor(h * dpr));
      const ctx = $constellation.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, w, h);
      if(nodes.length < 2) return;

      const points = nodes.map(n => ({
        id: n.id,
        type: n.type,
        x: (n.x / 100) * w,
        y: (n.y / 100) * h
      }));

      const links = Array.from(getLinks());
      if(links.length === 0) return;

      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(140, 170, 255, 0.25)';

      links.forEach((lk) => {
        const [a, b] = lk.split('|');
        const p = points.find(x => x.id === a);
        const q = points.find(x => x.id === b);
        if(!p || !q) return;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(q.x, q.y);
        ctx.stroke();
      });
    }

    function updateDrag(clientX, clientY){
      if(dragging === null) return;
      const rect = $sky.getBoundingClientRect();
      const x = ((clientX - rect.left) / rect.width) * 100;
      const y = ((clientY - rect.top) / rect.height) * 100;
      const node = dragging.node;
      if(!node) return;

      const nx = clamp(x, 4, 96);
      const ny = clamp(y, 6, 94);
      if(node.type === 'task'){
        node.ref.x = nx;
        node.ref.y = ny;
      } else {
        aggregatePositions.set(`${scope}:${node.id}`, { x: nx, y: ny });
      }
      node.x = nx;
      node.y = ny;

      const star = $sky.querySelector(`.star[data-idx="${dragging.idx}"]`);
      if(star){
        star.style.left = node.x + '%';
        star.style.top = node.y + '%';
      }
      drawConstellation(dragging.nodes);
    }

    function handleLinkClick(id, starEl){
      const links = getLinks();
      if(linkPendingId === null){
        linkPendingId = id;
        starEl.classList.add('is-selected');
        showToast('연결할 다음 별을 선택하세요.');
        return;
      }
      if(linkPendingId === id){
        linkPendingId = null;
        starEl.classList.remove('is-selected');
        return;
      }
      const key = linkKey(linkPendingId, id);
      if(links.has(key)) links.delete(key);
      else links.add(key);
      linkPendingId = null;
      $sky.querySelectorAll('.star.is-selected').forEach(n => n.classList.remove('is-selected'));
      showToast('별자리가 이어졌어요.');
      render();
    }

    $add.addEventListener('click', addTask);
    $clear.addEventListener('click', clearAll);
    $openInput.addEventListener('click', () => {
      const isHidden = $composer.classList.contains('hidden');
      if(isHidden) openComposerAt();
      else closeComposer();
      $openInput.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      $openInput.textContent = isHidden ? '닫기' : '새 별';
    });
    $quickAdd.addEventListener('click', addTaskQuick);
    $quickCancel.addEventListener('click', closeComposer);
    $title.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        addTask();
      }
    });
    $quickTitle.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        addTaskQuick();
      }
    });

    document.querySelectorAll('.scope-btn').forEach(btn => {
      btn.addEventListener('click', () => setScope(btn.dataset.scope));
    });

    $list.addEventListener('click', (e) => {
      const toggle = e.target.closest('.toggle');
      const drill = e.target.closest('.drill');
      if(toggle){
        toggleDone(toggle.dataset.id);
      }
      if(drill){
        const nodes = buildNodes();
        const node = nodes.find(n => n.id === drill.dataset.key);
        if(node && node.group) drillDown(node.group);
      }
    });

    $sky.addEventListener('pointerdown', (e) => {
      const star = e.target.closest('.star');
      if(star){
        const nodes = buildNodes();
        const idx = Number(star.dataset.idx);
        const node = nodes[idx];
        if(!node) return;
        dragging = { idx, node, nodes, startX: e.clientX, startY: e.clientY, moved: false };
        $sky.setPointerCapture(e.pointerId);
        longPressTimer = setTimeout(() => {
          if(node.type === 'task'){
            handleLinkClick(node.ref.id, star);
          }
        }, 500);
        return;
      }
      longPressTimer = setTimeout(() => {
        const rect = $sky.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        pendingPos = { x: clamp(x, 4, 96), y: clamp(y, 6, 94) };
        openComposerAt(e.clientX, e.clientY - 10);
      }, 450);
    });
    $sky.addEventListener('pointermove', (e) => {
      if(!dragging) return;
      const dx = e.clientX - dragging.startX;
      const dy = e.clientY - dragging.startY;
      if(Math.hypot(dx, dy) > 4){
        dragging.moved = true;
        clearTimeout(longPressTimer);
      }
      updateDrag(e.clientX, e.clientY);
    });
    $sky.addEventListener('pointerup', () => {
      clearTimeout(longPressTimer);
      if(dragging && dragging.moved) suppressClickOnce = true;
      dragging = null;
    });
    $sky.addEventListener('pointerleave', () => {
      clearTimeout(longPressTimer);
      dragging = null;
    });
    $sky.addEventListener('click', (e) => {
      if(suppressClickOnce){
        suppressClickOnce = false;
        return;
      }
      const star = e.target.closest('.star');
      if(star) return;
      const rect = $sky.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      pendingPos = { x: clamp(x, 4, 96), y: clamp(y, 6, 94) };
      openComposerAt(e.clientX, e.clientY - 10);
    });
    document.addEventListener('click', (e) => {
      const inComposer = e.target.closest('#composer');
      const isOpen = !$composer.classList.contains('hidden');
      if(!inComposer && isOpen && !e.target.closest('#openInput')){
        closeComposer();
      }
    });
    window.addEventListener('resize', () => render());

    const today = new Date();
    $date.value = toISO(today);
    focusDate = today;

    $introStart.addEventListener('click', () => {
      $intro.remove();
      openComposerAt();
    });
    $introLater.addEventListener('click', () => {
      $intro.remove();
    });

    render();
  </script>
</body>
</html>
